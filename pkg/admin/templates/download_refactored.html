{{/* é‡æ„åçš„ä¸‹è½½æ¨¡æ¿ - download_refactored.html */}}
{{define "download_refactored"}}
{{template "layout" .}}

{{/* è‡ªå®šä¹‰é¡µé¢æ ‡é¢˜ */}}
{{define "title"}}ä¸‹è½½æ¨¡å— - Athensä»“åº“ç®¡ç†ç³»ç»Ÿ{{end}}

{{/* åŒ…å«ä¸‹è½½ç‰¹å®šæ ·å¼ */}}
{{define "page-styles"}}
{{template "download-styles" .}}
{{end}}

{{/* åŒ…å«ä¾§è¾¹æ  */}}
{{define "sidebar"}}
{{template "sidebar" .}}
{{end}}

{{/* ä¸»è¦å†…å®¹åŒºåŸŸ */}}
{{define "content"}}
<div class="content-header">
    <div class="content-title">ä¸‹è½½æ¨¡å—</div>
    <div class="breadcrumb">
        <a href="/admin/dashboard">é¦–é¡µ</a> &gt; ä¸‹è½½æ¨¡å—
    </div>
</div>

<div class="download-container">
    <!-- ä¸‹è½½ç»Ÿè®¡ -->
    <div class="download-stats">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-number">{{.Stats.TotalModules | default "0"}}</div>
            <div class="stat-label">å¯ç”¨æ¨¡å—</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â¬‡ï¸</div>
            <div class="stat-number">{{.Stats.TotalDownloads | default "0"}}</div>
            <div class="stat-label">æ€»ä¸‹è½½é‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-number">{{.Stats.PopularModules | default "0"}}</div>
            <div class="stat-label">çƒ­é—¨æ¨¡å—</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ†•</div>
            <div class="stat-number">{{.Stats.RecentModules | default "0"}}</div>
            <div class="stat-label">æœ€æ–°æ¨¡å—</div>
        </div>
    </div>

    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-section">
        <div class="search-title">æœç´¢Goæ¨¡å—</div>
        <form class="search-form" id="searchForm">
            <div class="search-input-group">
                <label class="search-label" for="moduleQuery">æ¨¡å—åç§°æˆ–è·¯å¾„</label>
                <input type="text" 
                       class="search-input" 
                       id="moduleQuery" 
                       name="q" 
                       placeholder="ä¾‹å¦‚ï¼šgithub.com/gin-gonic/gin" 
                       value="{{.Query}}">
            </div>
            <button type="submit" class="search-button">ğŸ” æœç´¢</button>
        </form>
        
        <div class="search-examples">
            <strong>æœç´¢ç¤ºä¾‹ï¼š</strong><br>
            â€¢ å®Œæ•´è·¯å¾„ï¼šgithub.com/gorilla/mux<br>
            â€¢ æ¨¡å—åï¼šgin, echo, fiber<br>
            â€¢ ä½œè€…ï¼š@gorilla, @gin-gonic
        </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    {{if .Query}}
    <div class="results-section">
        <div class="results-header">
            <div>
                <div class="results-title">æœç´¢ç»“æœ</div>
                <div class="results-count">æ‰¾åˆ° {{len .Modules}} ä¸ªæ¨¡å—</div>
            </div>
            <div class="sort-options">
                <label class="sort-label">æ’åºï¼š</label>
                <select class="sort-select" id="sortSelect" onchange="applySorting()">
                    <option value="relevance">ç›¸å…³æ€§</option>
                    <option value="downloads">ä¸‹è½½é‡</option>
                    <option value="updated">æ›´æ–°æ—¶é—´</option>
                    <option value="name">åç§°</option>
                </select>
            </div>
        </div>

        {{if .Modules}}
        <div class="module-list">
            {{range .Modules}}
            <div class="module-item">
                <div class="module-header">
                    <div class="module-info">
                        <a href="/admin/modules/{{.Path}}" class="module-name">{{.Path}}</a>
                        <div class="module-version">{{.Version}}</div>
                        <div class="module-description">{{.Description | default "æš‚æ— æè¿°"}}</div>
                        <div class="module-meta">
                            <div class="meta-item">
                                <span class="meta-icon">â¬‡ï¸</span>
                                <span>{{.Downloads}} ä¸‹è½½</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ“…</span>
                                <span>{{.UpdatedAt}}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ“</span>
                                <span>{{.License | default "æœªçŸ¥è®¸å¯è¯"}}</span>
                            </div>
                            {{if .IsPrivate}}
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ”’</span>
                                <span>ç§æœ‰</span>
                            </div>
                            {{end}}
                        </div>
                    </div>
                    <div class="module-actions">
                        <a href="/admin/api/download/{{.Path}}@{{.Version}}" 
                           class="download-button" 
                           onclick="trackDownload('{{.Path}}', '{{.Version}}')">â¬‡ï¸ ä¸‹è½½</a>
                        <a href="/admin/modules/{{.Path}}" class="info-button">â„¹ï¸ è¯¦æƒ…</a>
                    </div>
                </div>
            </div>
            {{end}}
        </div>

        <!-- åˆ†é¡µ -->
        {{if .Pagination}}
        <div class="pagination">
            {{if .Pagination.HasPrev}}
                <a href="?q={{.Query}}&page={{.Pagination.PrevPage}}" class="pagination-button">&laquo; ä¸Šä¸€é¡µ</a>
            {{else}}
                <span class="pagination-button disabled">&laquo; ä¸Šä¸€é¡µ</span>
            {{end}}
            
            {{range .Pagination.Pages}}
                {{if eq . $.Pagination.CurrentPage}}
                    <span class="pagination-button active">{{.}}</span>
                {{else}}
                    <a href="?q={{$.Query}}&page={{.}}" class="pagination-button">{{.}}</a>
                {{end}}
            {{end}}
            
            {{if .Pagination.HasNext}}
                <a href="?q={{.Query}}&page={{.Pagination.NextPage}}" class="pagination-button">ä¸‹ä¸€é¡µ &raquo;</a>
            {{else}}
                <span class="pagination-button disabled">ä¸‹ä¸€é¡µ &raquo;</span>
            {{end}}
        </div>
        {{end}}

        {{else}}
        <!-- æ— æœç´¢ç»“æœ -->
        <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <div class="empty-title">æœªæ‰¾åˆ°ç›¸å…³æ¨¡å—</div>
            <div class="empty-description">
                æ²¡æœ‰æ‰¾åˆ°ä¸ "{{.Query}}" ç›¸å…³çš„Goæ¨¡å—ã€‚
            </div>
            <div class="empty-suggestions">
                <h4>æœç´¢å»ºè®®ï¼š</h4>
                <ul>
                    <li>æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
                    <li>å°è¯•ä½¿ç”¨æ›´é€šç”¨çš„å…³é”®è¯</li>
                    <li>ä½¿ç”¨å®Œæ•´çš„æ¨¡å—è·¯å¾„</li>
                    <li>æŸ¥çœ‹çƒ­é—¨æ¨¡å—åˆ—è¡¨è·å–çµæ„Ÿ</li>
                </ul>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <!-- é»˜è®¤çŠ¶æ€ - æ˜¾ç¤ºçƒ­é—¨æ¨¡å— -->
    <div class="results-section">
        <div class="results-header">
            <div>
                <div class="results-title">çƒ­é—¨æ¨¡å—</div>
                <div class="results-count">æœ€å—æ¬¢è¿çš„Goæ¨¡å—</div>
            </div>
        </div>

        {{if .PopularModules}}
        <div class="module-list">
            {{range .PopularModules}}
            <div class="module-item">
                <div class="module-header">
                    <div class="module-info">
                        <a href="/admin/modules/{{.Path}}" class="module-name">{{.Path}}</a>
                        <div class="module-version">{{.Version}}</div>
                        <div class="module-description">{{.Description | default "æš‚æ— æè¿°"}}</div>
                        <div class="module-meta">
                            <div class="meta-item">
                                <span class="meta-icon">â¬‡ï¸</span>
                                <span>{{.Downloads}} ä¸‹è½½</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ“…</span>
                                <span>{{.UpdatedAt}}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ“</span>
                                <span>{{.License | default "æœªçŸ¥è®¸å¯è¯"}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="module-actions">
                        <a href="/admin/api/download/{{.Path}}@{{.Version}}" 
                           class="download-button" 
                           onclick="trackDownload('{{.Path}}', '{{.Version}}')">â¬‡ï¸ ä¸‹è½½</a>
                        <a href="/admin/modules/{{.Path}}" class="info-button">â„¹ï¸ è¯¦æƒ…</a>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state">
            <div class="empty-icon">ğŸ“¦</div>
            <div class="empty-title">æš‚æ— å¯ç”¨æ¨¡å—</div>
            <div class="empty-description">
                Athensä»“åº“ä¸­è¿˜æ²¡æœ‰ä»»ä½•Goæ¨¡å—ã€‚<br>
                è¯·å…ˆä¸Šä¼ ä¸€äº›æ¨¡å—æˆ–é…ç½®ä»£ç†è·å–ã€‚
            </div>
            <a href="/admin/upload" class="download-button" style="display: inline-block; margin-top: 20px;">ä¸Šä¼ æ¨¡å—</a>
        </div>
        {{end}}
    </div>
    {{end}}
</div>
{{end}}

{{/* è‡ªå®šä¹‰è„šæœ¬ */}}
{{define "scripts"}}
<script>
// æœç´¢è¡¨å•å¤„ç†
document.getElementById('searchForm').addEventListener('submit', function(e) {
    const query = document.getElementById('moduleQuery').value.trim();
    if (!query) {
        e.preventDefault();
        alert('è¯·è¾“å…¥è¦æœç´¢çš„æ¨¡å—åç§°');
        return;
    }
});

// æ’åºåŠŸèƒ½
function applySorting() {
    const sortValue = document.getElementById('sortSelect').value;
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('sort', sortValue);
    window.location.href = '?' + urlParams.toString();
}

// ä¸‹è½½è·Ÿè¸ª
function trackDownload(modulePath, version) {
    // å‘é€ä¸‹è½½ç»Ÿè®¡
    fetch('/admin/api/track-download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module: modulePath,
            version: version,
            timestamp: new Date().toISOString()
        })
    }).catch(error => {
        console.log('ä¸‹è½½ç»Ÿè®¡å‘é€å¤±è´¥:', error);
    });
    
    console.log(`ä¸‹è½½æ¨¡å—: ${modulePath}@${version}`);
}

// æœç´¢å»ºè®®åŠŸèƒ½
function setupSearchSuggestions() {
    const searchInput = document.getElementById('moduleQuery');
    let suggestionTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(suggestionTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) return;
        
        suggestionTimeout = setTimeout(() => {
            fetchSuggestions(query);
        }, 300);
    });
}

// è·å–æœç´¢å»ºè®®
function fetchSuggestions(query) {
    fetch(`/admin/api/suggestions?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            showSuggestions(data.suggestions || []);
        })
        .catch(error => {
            console.log('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
        });
}

// æ˜¾ç¤ºæœç´¢å»ºè®®
function showSuggestions(suggestions) {
    // ç§»é™¤ç°æœ‰çš„å»ºè®®åˆ—è¡¨
    const existingSuggestions = document.querySelector('.search-suggestions');
    if (existingSuggestions) {
        existingSuggestions.remove();
    }
    
    if (suggestions.length === 0) return;
    
    // åˆ›å»ºå»ºè®®åˆ—è¡¨
    const suggestionsList = document.createElement('div');
    suggestionsList.className = 'search-suggestions';
    suggestionsList.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    `;
    
    suggestions.forEach(suggestion => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.style.cssText = `
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        `;
        item.textContent = suggestion;
        
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f5f5f5';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'white';
        });
        
        item.addEventListener('click', function() {
            document.getElementById('moduleQuery').value = suggestion;
            suggestionsList.remove();
            document.getElementById('searchForm').submit();
        });
        
        suggestionsList.appendChild(item);
    });
    
    // æ·»åŠ åˆ°æœç´¢è¾“å…¥æ¡†çš„çˆ¶å®¹å™¨
    const searchInputGroup = document.querySelector('.search-input-group');
    searchInputGroup.style.position = 'relative';
    searchInputGroup.appendChild(suggestionsList);
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—å»ºè®®
    document.addEventListener('click', function(e) {
        if (!searchInputGroup.contains(e.target)) {
            suggestionsList.remove();
        }
    }, { once: true });
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä¸‹è½½é¡µé¢å·²åŠ è½½');
    
    // è®¾ç½®æœç´¢å»ºè®®
    setupSearchSuggestions();
    
    // æ¢å¤æ’åºçŠ¶æ€
    const urlParams = new URLSearchParams(window.location.search);
    const sortValue = urlParams.get('sort');
    if (sortValue) {
        document.getElementById('sortSelect').value = sortValue;
    }
    
    // è‡ªåŠ¨èšç„¦æœç´¢æ¡†
    if (!urlParams.get('q')) {
        document.getElementById('moduleQuery').focus();
    }
});
</script>
{{end}}
{{end}}